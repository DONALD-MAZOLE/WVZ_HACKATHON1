<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Electronic License Verification (Local Test)</title>
Â  Â  <!-- Load Tailwind CSS for styling -->
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <!-- Use Inter font family -->
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #f7f9fb;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card {
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Custom scrollbar for review queue */
Â  Â  Â  Â  #reviewQueueOutput {
Â  Â  Â  Â  Â  Â  scrollbar-width: thin;
Â  Â  Â  Â  Â  Â  scrollbar-color: #9ca3af #f3f4f6;
Â  Â  Â  Â  }
Â  Â  Â  Â  #reviewQueueOutput::-webkit-scrollbar {
Â  Â  Â  Â  Â  Â  width: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  #reviewQueueOutput::-webkit-scrollbar-thumb {
Â  Â  Â  Â  Â  Â  background-color: #9ca3af;
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-start justify-center">

Â  Â  <div class="w-full max-w-7xl">
Â  Â  Â  Â  <header class="text-center mb-10">
Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold text-gray-800">Electronic License Verification System</h1>
Â  Â  Â  Â  Â  Â  <p class="text-gray-500 mt-2">OCR scan, automatic validation, and audit trail for vehicle access.</p>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <!-- Main 3-Column Layout -->
Â  Â  Â  Â  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <!-- Upload Panel -->
Â  Â  Â  Â  Â  Â  <div class="card bg-white p-6 rounded-xl border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-semibold mb-4 text-indigo-600">1. Upload License ImageÂ </h2>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <p id="userIdDisplay" class="text-xs text-gray-500 mb-4 truncate">User ID: Loading...</p>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <!-- File Input (FIXED: Added onchange handler) -->
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="licenseFileInput" accept="image/*" onchange="previewImage()" class="w-full text-sm text-gray-700
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  file:mr-4 file:py-2 file:px-4
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  file:rounded-full file:border-0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  file:text-sm file:font-semibold
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  file:bg-indigo-50 file:text-indigo-600
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hover:file:bg-indigo-100
Â  Â  Â  Â  Â  Â  Â  Â  ">

Â  Â  Â  Â  Â  Â  Â  Â  <!-- Image Preview -->
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-6 border-2 border-dashed border-gray-300 rounded-lg p-4 h-64 flex items-center justify-center bg-gray-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="imagePreview" src="https://placehold.co/400x256/E0E7FF/5B21B6?text=Image+Preview" alt="License Preview" class="max-h-full max-w-full rounded-lg object-contain" onerror="this.onerror=null; this.src='https://placehold.co/400x256/E0E7FF/5B21B6?text=Image+Preview';" style="display: block;">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- Process Button -->
Â  Â  Â  Â  Â  Â  Â  Â  <button id="processButton" class="mt-6 w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out disabled:bg-indigo-300">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="buttonText">Extract & Validate License</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline-block hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <!-- Result Panel -->
Â  Â  Â  Â  Â  Â  <div class="card bg-white p-6 rounded-xl border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-semibold mb-4 text-green-600">2. Validation Status & Data</h2>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Message Box (Validation Status) -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="messageBox" class="p-4 rounded-lg bg-blue-50 text-blue-800 border border-blue-200 mb-4 font-medium" role="alert">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  System initializing...
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Main Validation Result -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="validationStatus" class="p-4 bg-gray-100 rounded-lg mb-4 text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl font-bold text-gray-500">Awaiting Scan</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <!-- Structured Data Output -->
Â  Â  Â  Â  Â  Â  Â  Â  <div id="resultOutput" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Data fields will be inserted here -->
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <!-- Admin Review Queue Panel -->
Â  Â  Â  Â  Â  Â  <div class="card bg-white p-6 rounded-xl border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-semibold mb-4 text-orange-600">3. Admin Review Queue (Audit)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-500 mb-4">Click to manually override status for required reviews.</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="reviewQueueOutput" class="space-y-3 max-h-[500px] overflow-y-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 text-sm italic p-2">Loading queue...</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
Â  Â  Â  Â  
Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  // --- LOCAL RUNNING SETUP ---
Â  Â  Â  Â  // 
Â  Â  Â  Â  // 1. GEMINI API KEY: Your key is correctly placed here.
Â  Â  Â  Â  const apiKey = "AIzaSyBVdKNU3eTSKl--3yWJlIzLPAg9YB4iBdo";Â 
Â  Â  Â  Â  const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

Â  Â  Â  Â  const appId = 'local-license-app'; // App ID for local Firestore pathing
Â  Â  Â  Â  
Â  Â  Â  Â  // 2. FIREBASE CONFIG: IMPORTANT - Replace this placeholder with your own project's Web App configuration
Â  Â  Â  Â  // to enable persistence (Review Queue/Audit Log).
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "YOUR_FIREBASE_API_KEY",
Â  Â  Â  Â  Â  Â  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "YOUR_PROJECT_ID",
Â  Â  Â  Â  Â  Â  storageBucket: "YOUR_PROJECT_ID.appspot.com",
Â  Â  Â  Â  Â  Â  messagingSenderId: "123456789012",
Â  Â  Â  Â  Â  Â  appId: "1:123456789012:web:abcdef1234567890abcdef"
Â  Â  Â  Â  };
Â  Â  Â  Â  // =========================================================================

Â  Â  Â  Â  // --- Firebase State ---
Â  Â  Â  Â  let db;
Â  Â  Â  Â  let auth;
Â  Â  Â  Â  let currentUserId = null;
Â  Â  Â  Â  let isFirebaseReady = false;

Â  Â  Â  Â  // --- Firebase & Auth Initialization ---
Â  Â  Â  Â  async function initFirebaseAndAuth() {
Â  Â  Â  Â  Â  Â  const isGeminiPlaceholder = apiKey.includes("YOUR_GEMINI_API_KEY");
Â  Â  Â  Â  Â  Â  const isFirebasePlaceholder = firebaseConfig.apiKey.includes("YOUR_FIREBASE_API_KEY");

Â  Â  Â  Â  Â  Â  if (isGeminiPlaceholder) {
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox("WARNING: Replace 'YOUR_GEMINI_API_KEY_HERE' in the code to enable scanning.", 'warn');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (isFirebasePlaceholder) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('reviewQueueOutput').innerHTML = '<p class="text-gray-500 text-sm italic p-2">Review Queue disabled: Configure Firebase to enable persistence.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userIdDisplay').textContent = `User ID: Not authenticated`;
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox("WARNING: Replace Firebase config placeholders to enable persistence (Review Queue).", 'warn');
Â  Â  Â  Â  Â  Â  Â  Â  isFirebaseReady = false;
Â  Â  Â  Â  Â  Â  Â  Â  // EXIT EARLY to prevent the Firebase API Key error
Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  Â  Â  db = getFirestore(app);
Â  Â  Â  Â  Â  Â  Â  Â  auth = getAuth(app);

Â  Â  Â  Â  Â  Â  Â  Â  // For local testing, we rely on Anonymous Sign-in
Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUserId = user.uid;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isFirebaseReady = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userIdDisplay').textContent = `User ID: ${currentUserId}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox(`Authentication successful. User ${currentUserId.substring(0, 8)}... is signed in.`, 'info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadReviewQueue();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUserId = crypto.randomUUID(); // Fallback
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userIdDisplay').textContent = `User ID (Anon): ${currentUserId}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox("Signed in anonymously. System ready.", 'info');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadReviewQueue();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firebase initialization or authentication error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox(`Firebase Init Error: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- Utility Functions ---

Â  Â  Â  Â  function fileToBase64(file) {
Â  Â  Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const base64Data = reader.result.split(',')[1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve({ base64Data, mimeType: file.type });
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.onerror = error => reject(error);
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchWithBackoff(url, options, maxRetries = 5) {
Â  Â  Â  Â  Â  Â  for (let i = 0; i < maxRetries; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url, options);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorBody = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Attempt ${i + 1} failed with status: ${response.status}`, errorBody);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.status === 429 || response.status >= 500) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`API failed with status ${response.status}: ${errorBody.substring(0, 200)}...`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return response;
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Fetch error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i === maxRetries - 1) throw error;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- UI Handlers ---

Â  Â  Â  Â  function updateUIState(isLoading) {
Â  Â  Â  Â  Â  Â  const button = document.getElementById('processButton');
Â  Â  Â  Â  Â  Â  const buttonText = document.getElementById('buttonText');
Â  Â  Â  Â  Â  Â  const spinner = document.getElementById('loadingSpinner');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  button.disabled = isLoading;
Â  Â  Â  Â  Â  Â  buttonText.textContent = isLoading ? 'Processing...' : 'Extract & Validate License';
Â  Â  Â  Â  Â  Â  spinner.classList.toggle('hidden', !isLoading);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  document.getElementById('licenseFileInput').disabled = isLoading;
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateMessageBox(text, type = 'info') {
Â  Â  Â  Â  Â  Â  const box = document.getElementById('messageBox');
Â  Â  Â  Â  Â  Â  box.textContent = text;
Â  Â  Â  Â  Â  Â  box.className = 'p-4 rounded-lg mb-4 border font-medium';
Â  Â  Â  Â  Â  Â  switch (type) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'success': box.classList.add('bg-green-50', 'text-green-800', 'border-green-200'); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'error': box.classList.add('bg-red-50', 'text-red-800', 'border-red-200'); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'warn': box.classList.add('bg-yellow-50', 'text-yellow-800', 'border-yellow-200'); break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'info': default: box.classList.add('bg-blue-50', 'text-blue-800', 'border-blue-200'); break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function displayResults(data, validation) {
Â  Â  Â  Â  Â  Â  const outputDiv = document.getElementById('resultOutput');
Â  Â  Â  Â  Â  Â  const statusDiv = document.getElementById('validationStatus');
Â  Â  Â  Â  Â  Â  outputDiv.innerHTML = '';Â 

Â  Â  Â  Â  Â  Â  let statusColor, statusText;
Â  Â  Â  Â  Â  Â  switch (validation.status) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'VERIFIED':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusColor = 'bg-green-600 text-white'; statusText = 'ACCESS GRANTED'; break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'EXPIRED':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusColor = 'bg-red-600 text-white'; statusText = 'ACCESS DENIED: EXPIRED'; break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'NEEDS_REVIEW':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusColor = 'bg-yellow-600 text-gray-800'; statusText = 'MANUAL REVIEW REQUIRED'; break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'DENIED':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusColor = 'bg-red-600 text-white'; statusText = 'ACCESS DENIED'; break;
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusColor = 'bg-gray-400 text-white'; statusText = 'ERROR';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  statusDiv.className = `p-4 rounded-lg mb-4 text-center ${statusColor}`;
Â  Â  Â  Â  Â  Â  statusDiv.innerHTML = `<p class="text-2xl font-black">${statusText}</p>`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  updateMessageBox(`Validation Result: ${validation.message}`, validation.status === 'VERIFIED' ? 'success' : 'warn');

Â  Â  Â  Â  Â  Â  const fields = [
Â  Â  Â  Â  Â  Â  Â  Â  { key: 'fullName', label: 'Full Name', icon: 'ğŸ‘¤' },
Â  Â  Â  Â  Â  Â  Â  Â  { key: 'licenseNumber', label: 'License Number', icon: 'ğŸ”¢' },
Â  Â  Â  Â  Â  Â  Â  Â  { key: 'expirationDate', label: 'Expiration Date', icon: 'ğŸ“…' },
Â  Â  Â  Â  Â  Â  Â  Â  { key: 'licenseClass', label: 'Class', icon: 'ğŸš—' }
Â  Â  Â  Â  Â  Â  ];

Â  Â  Â  Â  Â  Â  fields.forEach(field => {
Â  Â  Â  Â  Â  Â  Â  Â  const value = data[field.key] || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  item.className = 'flex justify-between items-center p-3 bg-gray-50 border border-gray-200 rounded-lg';
Â  Â  Â  Â  Â  Â  Â  Â  item.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xl mr-3">${field.icon}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-medium text-gray-500">${field.label}:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-base font-semibold text-gray-800">${value}</span>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  outputDiv.appendChild(item);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Logic ---

Â  Â  Â  Â  window.previewImage = function() {
Â  Â  Â  Â  Â  Â  const fileInput = document.getElementById('licenseFileInput');
Â  Â  Â  Â  Â  Â  const preview = document.getElementById('imagePreview');
Â  Â  Â  Â  Â  Â  const file = fileInput.files[0];

Â  Â  Â  Â  Â  Â  // Reset UI elements when a new file is selected
Â  Â  Â  Â  Â  Â  document.getElementById('resultOutput').innerHTML = '';
Â  Â  Â  Â  Â  Â  document.getElementById('validationStatus').innerHTML = '<p class="text-xl font-bold text-gray-500">Awaiting Scan</p>';
Â  Â  Â  Â  Â  Â  document.getElementById('validationStatus').className = 'p-4 bg-gray-100 rounded-lg mb-4 text-center';

Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preview.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  preview.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox("Image loaded. Click 'Extract & Validate License' to process.", 'info');
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  preview.src = "https://placehold.co/400x256/E0E7FF/5B21B6?text=Image+Preview";
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox("Please upload an image.", 'info');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function performClientValidation(data) {
Â  Â  Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  Â  Â  today.setHours(0, 0, 0, 0);Â 
Â  Â  Â  Â  Â  Â  const expiryDate = data.expirationDate ? new Date(data.expirationDate) : null;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Check if the AI successfully detected the license at all
Â  Â  Â  Â  Â  Â  if (data.isDetected === false) {
Â  Â  Â  Â  Â  Â  Â  Â  Â return { status: 'DENIED', message: 'License object not clearly detected in image. ACCESS DENIED (Review Needed).' };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (expiryDate && data.expirationDate !== 'UNKNOWN') {
Â  Â  Â  Â  Â  Â  Â  Â  if (expiryDate < today) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { status: 'EXPIRED', message: 'License is expired. ACCESS DENIED.' };
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { status: 'VERIFIED', message: 'License is valid. ACCESS GRANTED.' };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // If isDetected is true but expirationDate is UNKNOWN, it needs review
Â  Â  Â  Â  Â  Â  Â  Â  return { status: 'NEEDS_REVIEW', message: 'Expiration date missing or unreadable. Manual review required.' };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveVerification(data, validation) {
Â  Â  Â  Â  Â  Â  // Guard clause for local mode if Firebase is not configured
Â  Â  Â  Â  Â  Â  if (!isFirebaseReady || !db || !currentUserId) return;

Â  Â  Â  Â  Â  Â  const collectionPath = `artifacts/${appId}/public/data/license_verifications`;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collection(db, collectionPath), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId: currentUserId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: validation.status,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  validationMessage: validation.message,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  extractedData: data,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isManualReview: validation.status === 'NEEDS_REVIEW' || validation.status === 'DENIED', // Flag for initial review status
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminReviewedBy: null,
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error saving verification:", e);
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox(`Error saving verification to Firestore: ${e.message}. Check your Firebase Config and Rules.`, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  window.updateReviewStatus = async function(docId, newStatus) {
Â  Â  Â  Â  Â  Â  // Guard clause for local mode if Firebase is not configured
Â  Â  Â  Â  Â  Â  if (!isFirebaseReady || !db || !currentUserId) {
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox("Firestore not configured. Cannot update status.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const docRef = doc(db, `artifacts/${appId}/public/data/license_verifications`, docId);
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Update status and clear the manual review flag by setting adminReviewedBy
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(docRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: newStatus,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  validationMessage: `Manual override: ${newStatus}`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminReviewedBy: currentUserId,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isManualReview: false, // Explicitly set to false after review action
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox(`Record updated to ${newStatus}.`, 'success');
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox(`Update failed: ${e.message}`, 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadReviewQueue() {
Â  Â  Â  Â  Â  Â  // Guard clause for local mode if Firebase is not configured
Â  Â  Â  Â  Â  Â  if (!isFirebaseReady || !db) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('reviewQueueOutput').innerHTML = '<p class="text-gray-500 text-sm italic p-2">Review Queue disabled: Configure Firebase to enable persistence.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const reviewQueueDiv = document.getElementById('reviewQueueOutput');
Â  Â  Â  Â  Â  Â  const q = query(collection(db, `artifacts/${appId}/public/data/license_verifications`));
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  onSnapshot(q, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  reviewQueueDiv.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reviewQueueDiv.innerHTML = '<p class="text-gray-500 text-sm italic p-2">Queue empty.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  snapshot.docs.forEach((docSnap) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const docId = docSnap.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let statusClass, icon, isActionable;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Determine display status and if manual action is needed
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const requiresAction = data.isManualReview && !data.adminReviewedBy;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  switch (data.status) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'VERIFIED': statusClass = 'bg-green-100 border-green-400'; icon = 'âœ…'; isActionable = false; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'EXPIRED': statusClass = 'bg-red-100 border-red-400'; icon = 'ğŸ›‘'; isActionable = false; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'DENIED': statusClass = 'bg-red-100 border-red-400'; icon = 'âŒ'; isActionable = requiresAction; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'NEEDS_REVIEW':Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  default: statusClass = 'bg-yellow-100 border-yellow-400'; icon = 'âš ï¸'; isActionable = requiresAction; break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.adminReviewedBy) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusClass = 'bg-blue-100 border-blue-400';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let actionButtons = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isActionable) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButtons = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2 flex space-x-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateReviewStatus('${docId}', 'VERIFIED')" class="flex-1 px-2 py-1 text-xs font-bold bg-green-500 text-white rounded hover:bg-green-600">Verify</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateReviewStatus('${docId}', 'DENIED')" class="flex-1 px-2 py-1 text-xs font-bold bg-red-500 text-white rounded hover:bg-red-600">Deny</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.className = `p-3 rounded-xl border mb-3 shadow-md ${statusClass}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  item.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="font-bold text-gray-800 flex items-center"><span class="mr-2">${icon}</span> ${data.extractedData?.fullName || 'Unknown'}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-gray-600">ID: ${docId.substring(0, 6)}... | Status: ${data.status}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs italic text-gray-700 mt-1">${data.validationMessage}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${data.adminReviewedBy ? `<div class="text-xs text-blue-700 font-semibold mt-1">Reviewed by: ${data.adminReviewedBy.substring(0, 8)}...</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButtons}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Prepend to show newest at the top
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reviewQueueDiv.prepend(item);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  window.processImage = async function() {
Â  Â  Â  Â  Â  Â  const file = document.getElementById('licenseFileInput').files[0];
Â  Â  Â  Â  Â  Â  if (!file) { updateMessageBox("Select an image first.", 'warn'); return; }
Â  Â  Â  Â  Â  Â  if (apiKey.includes("YOUR_GEMINI_API_KEY")) {
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox("Scanning blocked: Please replace 'YOUR_GEMINI_API_KEY_HERE' with your actual key.", 'error');Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  updateUIState(true);
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox('Scanning license with AI...', 'info');
Â  Â  Â  Â  Â  Â  Â  Â  const { base64Data, mimeType } = await fileToBase64(file);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const prompt = "Extract license data. Dates should be strictly formatted as YYYY-MM-DD. If a field is unreadable, use 'UNKNOWN'. If no driver's license object is clearly visible, set isDetected to false.";

Â  Â  Â  Â  Â  Â  Â  Â  const responseSchema = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: "OBJECT",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  properties: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "fullName": { "type": "STRING" }, "licenseNumber": { "type": "STRING" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "dateOfBirth": { "type": "STRING" }, "expirationDate": { "type": "STRING" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "licenseClass": { "type": "STRING" }, "issuingAuthority": { "type": "STRING" },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "isDetected": { "type": "BOOLEAN" }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  required: ["fullName", "licenseNumber", "expirationDate", "isDetected"]
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  // --- FIX APPLIED HERE: Separate text and image into different parts (Original code already did this) ---
Â  Â  Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  contents: [{Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  role: "user",Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parts: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { text: prompt }, // Part 1: Text prompt
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { inlineData: { mimeType, data: base64Data } } // Part 2: Image data
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  generationConfig: { responseMimeType: "application/json", responseSchema: responseSchema }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  // ---------------------------------------------------------------------

Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetchWithBackoff(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let jsonStr = result.candidates[0].content.parts[0].text;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Clean up potential markdown formatting around JSON
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  jsonStr = jsonStr.replace(/```json|```/g, '').trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = JSON.parse(jsonStr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const validation = performClientValidation(data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayResults(data, validation);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await saveVerification(data, validation);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox("AI scan failed. Please check your API key and network connection.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  updateMessageBox(`Error during processing: ${e.message}`, 'error');
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  updateUIState(false);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Initialize
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  // Bind process button
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('processButton');
Â  Â  Â  Â  Â  Â  if(btn) btn.addEventListener('click', window.processImage);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Note: The file input binding is in the HTML via onchange="previewImage()"
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  initFirebaseAndAuth();
Â  Â  Â  Â  });

Â  Â  </script>

</body>
</html>
